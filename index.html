<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 é™¤å¤•æ’é˜äººæµå›å ±</title>
    <style>
        :root {
            --primary-blue: #007bff;
            --primary-orange: #ff9800;
            --bg-dark: #121212;
            --text-light: #ffffff;
            --text-dim: #cccccc; /*ç¨å¾®èª¿äº®ä¸€é»ï¼Œè®“å°å­—æ›´æ¸…æ¥š*/
            --success-green: #28a745;
            --error-red: #dc3545;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-light);
            margin: 0;
            padding: 0;
            overscroll-behavior: none;
        }

        /* === 1. é ‚éƒ¨çœ‹æ¿å€ (çµ±ä¸€é«˜åº¦èˆ‡å­—é«”) === */
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            padding: 10px; /* ç¨å¾®ç¸®å°å…§è· */
            background-color: #1e1e1e;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }

        .stat-box {
            width: 48%;
            padding: 12px 5px;
            border-radius: 8px;
            text-align: center;
            display: flex;       /* ä½¿ç”¨ Flexbox è®“å…§å®¹ç½®ä¸­å°é½Š */
            flex-direction: column;
            justify-content: center;
        }

        .stat-box.blue { background-color: #004085; border: 1px solid var(--primary-blue); }
        .stat-box.orange { background-color: #854d00; border: 1px solid var(--primary-orange); }

        /* çœ‹æ¿æ¨™ç±¤ (Level 4: 16px) */
        .stat-label { font-size: 16px; color: var(--text-dim); margin-bottom: 5px; font-weight: normal; }
        /* çœ‹æ¿æ•¸å­— (Level 2+: 36px) - ç¨å¾®åŠ å¤§ */
        .stat-value { font-size: 36px; font-weight: bold; line-height: 1.1; }
        /* å–®ä½ (Level 4: 16px) */
        .stat-unit { font-size: 16px; font-weight: normal; margin-left: 2px; }


        /* === 2. Tab åˆ‡æ›å€ (çµ±ä¸€æ–‡å­—å¤§å°) === */
        .tab-container {
            display: flex;
            margin-top: 15px;
            padding: 0 10px;
        }

        .tab-btn {
            flex: 1;
            padding: 12px 5px;
            text-align: center;
            background: #333;
            color: #888;
            border: none;
            /* Tab æ–‡å­— (Level 4: 16px) - ç¢ºä¿é•·æ¨™é¡Œèƒ½æ›è¡Œä½†å­—ä¸ç¸®å¤ªå° */
            font-size: 16px; 
            font-weight: bold; 
            line-height: 1.3;
            border-radius: 10px 10px 0 0;
            margin: 0 2px;
            position: relative;
            /* è®“é•·æ–‡å­—å¯ä»¥è‡ªç„¶æ›è¡Œ */
            white-space: normal; 
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 50px; /* ç¢ºä¿å…©å€‹ Tab é«˜åº¦ä¸€è‡´ */
        }

        .tab-btn.active {
            background: #444;
            color: #fff;
        }

        .tab-btn.locked::after {
            content: "ğŸ”’";
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 10px;
        }


        /* === 3. æ“ä½œé¢æ¿å€ === */
        .control-panel {
            padding: 20px;
            background: #444;
            min-height: calc(100vh - 200px); /* è®“å®ƒä½”æ»¿å‰©é¤˜é«˜åº¦ */
            display: none; 
        }

        .control-panel.active { display: block; }

        /* æ¨™é¡Œæ–‡å­— (Level 3: 20px) */
        .control-panel h3 {
            font-size: 20px;
            font-weight: normal;
            color: #ccc;
            margin: 10px 0 20px 0;
            text-align: center;
        }

        /* é¡¯ç¤ºæ•¸å­—/è¼¸å…¥æ¡† (Level 1: 80px) - ç¶­æŒå·¨å¤§ */
        .number-display, .number-input {
            font-size: 80px;
            font-weight: bold;
            text-align: center;
            margin: 10px 0 30px 0; /* å¢åŠ ä¸‹æ–¹è·é›¢ */
            display: block;
            width: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; /* å¼·åˆ¶æ•¸å­—å­—é«” */
        }
        
        .number-display { color: var(--primary-blue); }
        .control-panel.orange .number-display { color: var(--primary-orange); }

        /* è¼¸å…¥æ¡†ç‰¹åŒ–æ¨£å¼ */
        .number-input {
            background: transparent;
            border: none;
            border-bottom: 2px solid #666;
            color: inherit;
            outline: none;
            padding: 5px 0;
            -moz-appearance: textfield;
        }
        .number-input:focus { border-bottom: 2px solid #fff; }
        .number-input::-webkit-outer-spin-button,
        .number-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

/* === ä¿®æ”¹ï¼šçµ±ä¸€æŒ‰éˆ•æ¨£å¼ === */
        .btn-group {
            display: flex;
            justify-content: space-between;
            gap: 15px; /* æŒ‰éˆ•å·¦å³é–“è· */
            margin-bottom: 15px; /* æŒ‰éˆ•ä¸Šä¸‹æ’é–“è· */
        }

        .btn-action {
            flex: 1;                /* è‡ªå‹•å¡«æ»¿å¯¬åº¦ */
            height: 80px;           /* è¨­å®šå›ºå®šé«˜åº¦ï¼Œç¢ºä¿ä¸€æ¨£é«˜ */
            font-size: 32px;        /* çµ±ä¸€å­—é«”å¤§å° */
            font-weight: bold;
            border: 2px solid #555; /* çµ±ä¸€é‚Šæ¡† */
            border-radius: 12px;
            background-color: #333; /* çµ±ä¸€èƒŒæ™¯è‰² (æ·±ç°è‰²) */
            color: white;
            
            /* è§¸æ§å„ªåŒ– */
            touch-action: manipulation; 
            box-shadow: 0 4px 0 rgba(0,0,0,0.3); /* ç«‹é«”æ„Ÿ */
            display: flex;
            align-items: center;    /* æ–‡å­—å‚ç›´ç½®ä¸­ */
            justify-content: center; /* æ–‡å­—æ°´å¹³ç½®ä¸­ */
        }

        .btn-action:active { 
            transform: translateY(4px); /* æŒ‰ä¸‹å»çš„æ•ˆæœ */
            box-shadow: none; 
        }

        /* é€å‡ºæŒ‰éˆ• (Level 3: 22px) - ç¨å¾®å°æ–¼æ•¸å­—æŒ‰éˆ•ï¼Œä½†è¦æ¸…æ¥š */
        .btn-submit {
            width: 100%;
            padding: 18px;
            font-size: 22px; 
            font-weight: bold;
            border: none;
            border-radius: 12px;
            background: var(--success-green);
            color: white;
            margin-top: 30px; /* èˆ‡ä¸Šæ–¹å€éš”é–‹ */
            box-shadow: 0 4px 0 rgba(0,0,0,0.2);
        }
        .btn-submit:active {
            transform: translateY(4px); 
            box-shadow: none; 
        }
        .btn-submit.disabled {
            background: #555;
            color: #aaa;
            pointer-events: none;
            box-shadow: none;
        }


        /* === 5. ç™»å…¥é®ç½© (Modal) === */
        #login-modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.95);
            z-index: 999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .login-card {
            background: #2c2c2c;
            padding: 30px;
            border-radius: 15px;
            width: 100%;
            max-width: 320px;
            text-align: center;
        }

        .login-input {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #444;
            background: #121212;
            color: #fff;
            font-size: 20px; /* ç™»å…¥å­—å¤§ä¸€é» */
            border-radius: 8px;
            box-sizing: border-box; 
            text-align: center;
        }

        .btn-login {
            width: 100%;
            padding: 15px;
            background: var(--primary-blue);
            color: white;
            border: none;
            font-size: 20px;
            font-weight: bold;
            border-radius: 8px;
            margin-top: 15px;
        }

        /* æç¤ºè¨Šæ¯ (Toast) */
        #toast {
            position: fixed;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.9);
            color: #000;
            padding: 12px 30px;
            border-radius: 50px;
            font-size: 18px;
            font-weight: bold;
            display: none;
            z-index: 200;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>

    <div class="dashboard-header">
        <div class="stat-box blue">
            <div class="stat-label">å¤§æ®¿å…§å…±æœ‰</div>
            <div class="stat-value" id="dash-hall">-- <span class="stat-unit">äºº</span></div>
        </div>
        <div class="stat-box orange">
            <div class="stat-label">ç´¯è¨ˆç§»å‹•å¾€ä¸‹</div>
            <div class="stat-value" id="dash-platform">-- <span class="stat-unit">äºº</span></div>
        </div>
    </div>

    <div id="login-modal">
        <div class="login-card">
            <h2 style="color: #fff; margin-bottom: 20px;">é™¤å¤•æ’é˜å¿—å·¥ç™»å…¥</h2>
            <input type="email" id="input-email" class="login-input" placeholder="è«‹è¼¸å…¥ Email">
            <input type="tel" id="input-passcode" class="login-input" placeholder="4ä½æ•¸é€šè¡Œç¢¼" maxlength="4">
            <button class="btn-login" onclick="performLogin()">é©— è­‰ èº« åˆ†</button>
            <p id="login-msg" style="color: var(--error-red); margin-top: 10px;"></p>
        </div>
    </div>

    <div class="tab-container">
        <button class="tab-btn locked" id="tab-hall" onclick="switchTab('hall')">å¤§æ®¿äººæ•¸</button>
        <button class="tab-btn locked" id="tab-platform" onclick="switchTab('platform')">å¤§æ®¿ç§»å‹•å‰å¾€ä¸‹å¹³å°ç¸½äººæ•¸</button>
    </div>

<div id="panel-hall" class="control-panel">
        <div class="number-display" id="val-hall">0</div>
        
        <div class="btn-group">
            <button class="btn-action" onclick="instantUpdate('hall', -1)">-1</button>
            <button class="btn-action" onclick="instantUpdate('hall', 1)">+1</button>
        </div>

        <div class="btn-group">
            <button class="btn-action" onclick="instantUpdate('hall', 5)">+5</button>
            <button class="btn-action" onclick="instantUpdate('hall', 10)">+10</button>
        </div>
    </div>

    <div id="panel-platform" class="control-panel orange">
        <h3 style="text-align: center; color: #ccc;">æ–°å¢ï¼šé€™æ¢¯æ¬¡å¸¶èµ°å¤šå°‘äººï¼Ÿ</h3>
        
        <input type="number" id="val-platform" class="number-input" value="0" inputmode="numeric" onchange="syncInput('platform')">
        
        <button class="btn-submit" style="background: var(--primary-orange);" onclick="submitData('platform')">æ›´æ–°å¤§æ®¿ç§»å‹•å‰å¾€ä¸‹å¹³å°ç¸½äººæ•¸</button>
    </div>

    <div id="toast">è³‡æ–™å·²æ›´æ–°</div>

    <script>
        // === å…¨åŸŸè®Šæ•¸ ===
        const API_URL = "https://script.google.com/macros/s/AKfycbxA-GhOjYIgRgmPukNnPYstJgQYskKUrf1j2prChtkaoYNF2jC-VHd8lol4xGCmPXsF/exec"; 
        
        let currentUser = null;
        let userPermissions = []; 
        let currentValues = { hall: 0, platform: 0 }; 

        // === 1. ç™»å…¥é‚è¼¯ ===
        function performLogin() {
            const email = document.getElementById('input-email').value.trim();
            const passcode = document.getElementById('input-passcode').value.trim();
            const btn = document.querySelector('.btn-login');
            const msg = document.getElementById('login-msg');

            if (!email || !passcode) {
                msg.textContent = "è«‹å®Œæ•´è¼¸å…¥";
                return;
            }

            btn.textContent = "é©—è­‰ä¸­...";
            btn.disabled = true;

            fetch(`${API_URL}?action=login&email=${email}&passcode=${passcode}`)
            .then(res => res.json())
            .then(data => {
                if (data.status === "success") {
                    currentUser = email;
                    // è‡ªå‹•å»é™¤ç©ºæ ¼
                    userPermissions = data.access.map(p => p.trim());
                    
                    document.getElementById('login-modal').style.display = 'none';
                    unlockTabs();
                    startPolling(); 
                } else {
                    msg.textContent = "é©—è­‰å¤±æ•—ï¼šå¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤";
                    btn.textContent = "é©— è­‰ èº« åˆ†";
                    btn.disabled = false;
                }
            })
            .catch(err => {
                console.error(err);
                msg.textContent = "é€£ç·šéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦";
                btn.textContent = "é©— è­‰ èº« åˆ†";
                btn.disabled = false;
            });
        }

        // === 2. æ¬Šé™è§£é–é‚è¼¯ ===
        function unlockTabs() {
            console.log("ç•¶å‰ä½¿ç”¨è€…æ¬Šé™:", userPermissions);

            const checkAccess = (keyword) => {
                return userPermissions.some(p => p.includes(keyword));
            };

            // è§£é– [å¤§æ®¿] Tab
            if (checkAccess("å¤§æ®¿")) {
                const tab = document.getElementById('tab-hall');
                if(tab) {
                    tab.classList.remove('locked');
                    switchTab('hall');
                }
            }

            // è§£é– [ä¸‹å¹³å°] Tab
            if (checkAccess("ä¸‹å¹³å°")) {
                const tab = document.getElementById('tab-platform');
                if(tab) {
                    tab.classList.remove('locked');
                    if (!checkAccess("å¤§æ®¿")) {
                        switchTab('platform');
                    }
                }
            }
        }

        function switchTab(target) {
            const map = { 'hall': 'å¤§æ®¿', 'platform': 'ä¸‹å¹³å°' };
            const requiredPerm = map[target];

            const checkAccess = (keyword) => {
                return userPermissions.some(p => p.includes(keyword));
            };

            if (!checkAccess(requiredPerm)) {
                showToast(`ğŸš« æ‚¨æ²’æœ‰${requiredPerm}çš„å›å ±æ¬Šé™`);
                return;
            }

            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.control-panel').forEach(p => p.classList.remove('active'));

            document.getElementById(`tab-${target}`).classList.add('active');
            document.getElementById(`panel-${target}`).classList.add('active');
        }

        // === 3. æ•¸å€¼èª¿æ•´é‚è¼¯ (å¤§æ®¿å³æ™‚æ›´æ–°å°ˆç”¨) ===
        function instantUpdate(type, delta) {
            // 1. å¾è®Šæ•¸æˆ–ç•«é¢å–å¾—ç•¶å‰æ•¸å€¼
            let currentVal = currentValues[type] || 0;
            
            // 2. è¨ˆç®—æ–°æ•¸å€¼
            let newVal = currentVal + delta;
            if (newVal < 0) newVal = 0;

            // 3. æ›´æ–°ç•«é¢èˆ‡å…¨åŸŸè®Šæ•¸
            currentValues[type] = newVal;
            document.getElementById(`val-${type}`).textContent = newVal;

            // 4. ç›´æ¥ç™¼é€è³‡æ–™ (True ä»£è¡¨å³æ™‚æ¨¡å¼)
            submitData(type, true); 
        }

        // === 4. æ‰‹å‹•è¼¸å…¥åŒæ­¥é‚è¼¯ (ä¸‹å¹³å°å°ˆç”¨) ===
        function syncInput(type) {
            const input = document.getElementById(`val-${type}`);
            let val = parseInt(input.value);
            
            if (isNaN(val) || val < 0) val = 0;
            
            currentValues[type] = val;
            input.value = val; 
        }

        // === 5. é€å‡ºè³‡æ–™é‚è¼¯ (æ”¯æ´å³æ™‚èˆ‡ç¢ºèªå…©ç¨®æ¨¡å¼) ===
        function submitData(type, isInstant = false) {
            const val = currentValues[type];
            const targetName = (type === 'hall') ? 'å¤§æ®¿' : 'ä¸‹å¹³å°';
            
            // éå³æ™‚æ¨¡å¼ (ä¸‹å¹³å°) æ‰éœ€è¦ç¢ºèª
            if (!isInstant) {
                if (!confirm(`ç¢ºå®šé€å‡ºã€Œ${targetName}ã€æ•¸æ“šï¼š${val} äººå—ï¼Ÿ`)) return;
            }

            // UI ç‹€æ…‹è™•ç†
            if (isInstant) {
                showToast(`å‚³é€ä¸­...`);
            } else {
                const btn = document.querySelector(`#panel-${type} .btn-submit`);
                if(btn) {
                    btn.textContent = "å‚³é€ä¸­...";
                    btn.classList.add('disabled');
                }
            }

            fetch(`${API_URL}?action=updateData&target=${targetName}&value=${val}&user=${currentUser}`)
            .then(res => res.json())
            .then(data => {
                if (data.status === "success") {
                    showToast(`âœ… ${targetName} æ›´æ–°æˆåŠŸï¼`);
                    
                    // ä¸‹å¹³å°é€å‡ºå¾Œæ­¸é›¶
                    if (type === 'platform') {
                        currentValues['platform'] = 0;
                        const el = document.getElementById('val-platform');
                        if (el) el.value = 0;
                    }
                    
                    // ç«‹å³æ›´æ–°çœ‹æ¿
                    fetchDashboardData();
                } else {
                    showToast("âŒ æ›´æ–°å¤±æ•—ï¼š" + data.message);
                }
            })
            .catch(err => showToast("âŒ ç¶²è·¯é€£ç·šéŒ¯èª¤"))
            .finally(() => {
                // é‚„åŸæŒ‰éˆ• (åƒ…éå³æ™‚æ¨¡å¼)
                if (!isInstant) {
                    const btn = document.querySelector(`#panel-${type} .btn-submit`);
                    if(btn) {
                        const originalText = 'æ›´æ–°å¤§æ®¿ç§»å‹•å‰å¾€ä¸‹å¹³å°ç¸½äººæ•¸';
                        btn.textContent = originalText;
                        btn.classList.remove('disabled');
                    }
                }
            });
        }

        // === 6. çœ‹æ¿è‡ªå‹•æ›´æ–° ===
        function startPolling() {
            fetchDashboardData(); 
            setInterval(fetchDashboardData, 5000); 
        }

        function fetchDashboardData() {
            fetch(`${API_URL}?action=getDashboard&t=${new Date().getTime()}`)
            .then(res => res.json())
            .then(data => {
                if (data.status === "success") {
                    // æ›´æ–°é ‚éƒ¨çœ‹æ¿
                    document.getElementById('dash-hall').innerHTML = `${data.hall_final} <span class="stat-unit">äºº</span>`;
                    document.getElementById('dash-platform').innerHTML = `${data.platform_total} <span class="stat-unit">äºº</span>`;
                    
                    // === é—œéµåŒæ­¥ï¼šè®“å¤§æ®¿æ“ä½œå€çš„æ•¸å­—è·Ÿè‘—çœ‹æ¿èµ° ===
                    // é€™æ¨£å¿—å·¥æ¯æ¬¡æŒ‰ +1 éƒ½æ˜¯åŸºæ–¼æœ€æ–°çš„å³æ™‚äººæ•¸
                    if (data.hall_final !== undefined) {
                        currentValues['hall'] = parseInt(data.hall_final);
                        const hallDisplay = document.getElementById('val-hall');
                        if (hallDisplay) hallDisplay.textContent = currentValues['hall'];
                    }
                }
            });
        }

        // === å·¥å…· ===
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.style.display = 'block';
            setTimeout(() => { t.style.display = 'none'; }, 2000); // 2ç§’å¾Œæ¶ˆå¤±ï¼Œé¿å…æ“‹ä½å¤ªä¹…
        }
    </script>
</body>
</html>
